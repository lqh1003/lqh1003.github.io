---
title: input文件上传
date: 2025-08-12 17:34:48
tags:
  - 上传
  - input

categories: 上传/导出
cover: /images/input文件上传/cover.jpg # 封面图
---

### *** Base64 的格式入参 ***

```html
<img :src="iconFile" alt="" @click="getResoureUrl(1)" />
<img :src="iconCamera" alt="" @click="getResoureUrl(2)" />
<img :src="iconVideo" alt="" @click="getResoureUrl(3)" />
<input type="file" id="fileUpload" v-show="false" />
<input type="file" id="imageUpload" accept="image/*" v-show="false" />
<input type="file" id="videoUpload" accept="video/*" v-show="false" />
```

- 图片上传前，可以先进行压缩（图片优化处理） `npm i browser-image-compression`
- 资源上传共用方法 `getResoureUrl()`
- Base64 的格式入参资源文件
  `const reader = new FileReader()`
  `reader.readAsDataURL(file)`
  `reader.onload = async (e) => {}`
- 【注意】当重复上传相同的文件/图片/视频时，不会触发change函数，造成上传失败，原因是：浏览器认为选择了相同名称的文件并不代表用户有新的操作，所以没有触发 change 事件

```javascript
// 图片上传前压缩处理(推荐)
import imageCompression from 'browser-image-compression'

// 正在上传的队列
const uploadQueue = ref([])
// 上传 1所有文件类型、2图片和3视频
const getResoureUrl = (resourceType) => {
	let idName = ''
	if (resourceType == 1) idName = 'fileUpload'
	else if (resourceType == 2) idName = 'imageUpload'
	else if (resourceType == 3) idName = 'videoUpload'

	nextTick(() => {
		/**
		 * BUG：当多个上传入口同时操作时，input 状态混乱，最后url赋值错位
		 * 解决：每个上传入口用独立的inputId，可以通过调用时传入(idName)
		 */
		const resoUp = document.getElementById(idName)

		if (!resoUp) return
		// 保证每次（点击）都能触发
		resoUp.value = ''
		// 先移除旧的监听
		resoUp.onchange = null

		resoUp?.click()

		// 事件监听用 onchange 代替 addEventListener('change')，每次覆盖，避免重复绑定
		resoUp.onchange = async function (event) {
			const upFile = event.target.files[0] // 获取文件对象
			if (!upFile) return

			/************************************
			 * 优化：（图片上传到服务器之前）先压缩图片
			 *  (1) 下载依赖npm i browser-image-compression
			 *  (2) vue文件中引入 import imageCompression from 'browser-image-compression';
			 *  (3) 使用 imageCompression 函数进行压缩
			 */
			const options = {
				maxSizeMB: 1, // 最大文件大小(MB)
				maxWidthOrHeight: 700, // （压缩后的）最大宽/高
				useWebWorker: true, // 使用WebWorker加速
				fileType: 'image/webp', // 可选转换为webp格式
			}
			const compressedFile = await imageCompression(upFile, options)
			// ************************************

			// 使用压缩后的文件compressedFile 或 原文件upFile
			const file = compressedFile || upFile
			const reader = new FileReader()
			reader.readAsDataURL(file) // 将文件读取为DataURL

			/*********************************
			 * 问题：当重复上传相同的文件/图片/视频时，不会触发change函数，造成上传失败
			 * 原因：浏览器认为选择了相同名称的文件并不代表用户有新的操作，所以没有触发 change 事件
			 * 解决：清除input的值，以便下次可上传同一张图片
			 */
			setTimeout(() => {
				event.target.value = ''
			})
			// ******************************

			if (file) {
				// input表单 file change监听文件上传事件多次触发， 使用数组uploadQueue帮助判断
				// console.log('*******图片点击多次*******')
				const fileKey = generateFileKey(file)
				if (uploadQueue.value.includes(fileKey)) return
				else {
					uploadQueue.value.push(fileKey)
				}
				reader.onload = async (e) => {
					// console.log('*******上传图片一次*******')
					// 开启loading
					try {
						const res = await postUploadImage({
							base64Str: e.target?.result,
							extName: file?.type.split('/')[1] || file?.name.split('.')[1], //文件后缀
						})
						// console.log('上传之后返回的资源链接：', res.data?.url)
						// 上传完成，置空，以便下次上传
						uploadQueue.value = []
					} catch (error) {
						console.log('error')
					} finally {
						// 关闭loading
					}
				}
			}
		}
	})
}
const generateFileKey = (file) => {
	// 使用文件名和大小生成唯一标识
	return file.name + file.size
}
```

- 资源上传接口(axios 封装)

```javascript
// 资源上传接口(axios封装)
import request from '../request.js'
//图片上传
export const postUploadImage = (params) => {
	const data = {
		extName: params.extName || 'png',
		sourceType: 'oho',
		serviceType: import.meta.env.VITE_SYSTEM_NAME,
		base64Str: params.base64Str.split(',')[1],
	}

	return request.post('/upload/file/uploadVideo', data, {
		headers: {
			// 'Content-Type': 'application/json;charset=utf-8',
			'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
		},
	})
}
```

### *** 文件流形式入参(表单提交、不需多加处理成 Base64) ***

```html
<div @click="changeAvater">上传</div>
<input v-show="false" id="changeAvatarUpload" type="file" accept="image/*" />
```

- 文件流形式入参资源文件 `formData.append('file', file)`

```javascript
const formValue = ref({
	avatar: '',
})
function changeAvater() {
	nextTick(() => {
		const resoUp = document.getElementById('changeAvatarUpload')
		resoUp?.click()

		resoUp?.addEventListener('change', async (event) => {
			const file = event.target.files[0] // 获取文件对象
			const formData = new FormData()
			formData.append('file', file) // file 入参字段名
			if (file) {
				try {
					await axios('/website/user/uploadAvatar', {
						method: 'POST',
						body: formData,
						headers: {
							'Accept-Language': 'zh-CN',
							Authorization: token,
							// 'Content-Type': 'multipart/form-data',
						},
						onResponse({ response }) {
							const { _data: res } = response
							if (res.code !== 0) {
								message.error(res?.msg || res?.message || 'error')
								return null
							} else {
								formValue.value.avatar = res.data
							}
						},
					})
				} catch (error) {
					console.log('error')
				}
			}
		})
	})
}
```
